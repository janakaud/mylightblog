<html>
<meta charset="utf-8"/>
<head>
	<script type="text/javascript" src="jquery-1.6.4.js"></script>
</head>
<body>
	<button onclick="authorize()">Authorize</button>
	<button id="validate" onclick="validate()">Validate</button>
	<button onclick="listBlogs()">Blogs</button>
	<select id="blogs" onchange="listPosts()"></select>
	<button onclick="listPosts(true)">All</button>
	<button onclick="listPosts(false)">Draft</button>
	<select id="posts"></select>
	<button onclick="loadPost()">Load</button>
	<button onclick="publish()">Publish</button>
	<button onclick="unpublish()">Unpublish</button>
	<button onclick="delPost()">Delete</button>
	<div style="width:100%">
		<div style="float:left;width:50%">
			<input id="title" style="width:100%"/>
			<textarea id="input" style="width:100%;height:80%"></textarea>
			<input id="labels" style="width:100%"/>
		</div>
		<div style="float:left;width:50%">
			<div id="preview" style="overflow-y:scroll;height:80%"/>
		</div>
	</div>
	<button onclick="newPost()">New Post</button>
	<button onclick="update()">Update</button>
	<script type="text/javascript">
		var acToken = localStorage.token;
		var expiry = localStorage.expiry;
		var oauthUrl = "https://accounts.google.com/o/oauth2/auth?";
		var scope = "https://www.googleapis.com/auth/blogger";
		var clientId = "149292588439-vmendckat24eusmct1buat1ino6hp9c9.apps.googleusercontent.com";
		var redirect = "http://127.0.0.1/blogger/oauth"
		var type = "token";
		var _url = oauthUrl + "scope=" + scope + "&client_id=" + clientId + "&redirect_uri=" + redirect + "&response_type=" + type;
		var dirty;

		function expired() {
			return !expiry || (new Date().getTime() - expiry >= 0);
		}
		
		function authorize(callback) {
			if(!expired())
				return callback();
			var win = window.open(_url, "OAuthor", "width=500,height=200"); 
			win.addEventListener("load", function(e) {
				var win = e.target;
				if (win.location.hash.indexOf("access_token") != -1) {
					var hash = win.location.hash;
					hash = hash.substring(hash.indexOf("access_token=") + 13);
					acToken = hash.substring(0, hash.indexOf("&"));
					localStorage.token = acToken;
					hash = hash.substring(hash.indexOf("expires_in=") + 11);
					expiry = new Date().getTime() + parseInt(hash)*1000;
					localStorage.expiry = expiry;
					callback();
				} else
					alert("Authorization failed");
			}, true);
		}
		
		function callWithAuth(callback) {
			if(expired())
				authorize(callback);
			else
				callback();
		}

		function validate() {
			$.ajax({
				type: "get",
				url: "https://www.googleapis.com/oauth2/v1/tokeninfo",
				data: {
					"access_token": acToken
				},
				success: function(data) {
					alert(JSON.stringify(data));
				}
			});
		}
		
		function populate(list, data, textParam) {
			list.empty();
			$.each(data.items, function(i, d) {
				list.append("<option value='" + d.id + "'>" + d[textParam] + "</option>");
			});
		}
		
		function ajax(method, url, data, success) {
			callWithAuth(function() {
				var req = {
					type: method,
					url: url,
					beforeSend: function(xhr) {
						xhr.withCredentials = true;
						xhr.setRequestHeader("Authorization", "Bearer " + acToken);
					},
					success: success,
					error: function(msg) {
						alert(JSON.stringify(msg, undefined, 2));
					}
				};
				if(data) {
					req.contentType = "application/json";
					req.data = JSON.stringify(data);
				}
				alert(JSON.stringify(req));
				$.ajax(req);
			});
		}
		
		function listPosts(all) {
			ajax("get", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts?status=draft" + (all ? "&status=live" : "") + "&fields=items(id,title)", null, function(data) {
				populate($("#posts"), data, "title");
			});
		}
		
		function listBlogs() {
			ajax("get", "https://www.googleapis.com/blogger/v3/users/self/blogs?fields=items(id,name)", null, function(data) {
				$("#posts").empty();
				populate($("#blogs"), data, "name");
			});
		}
		
		function loadPost() {
			if(!dirty || confirm("Post has been modified. Are you sure you want to discard?")) {
				ajax("get", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts/" + $("#posts").val() + "?view=AUTHOR&fields=title,content,labels", null, function(data) {
					$("#title").val(data.title);
					$("#input").val(data.content);
					$("#labels").val((data.labels || []).join(", "));
					dirty = false;
				});
			}
		}
		
		function submit(method, url) {
			if(dirty) {
				var labelTxt = $("#labels").val();
				var labels = [];
				if(labelTxt.length > 0)
					labels = labelTxt.split(/,\s*/g);
				for(var i in labels) {
					if(labels[i] == "") {
						alert("Invalid label");
						return;
					}
				}
				ajax(method, url, {"content": $("#input").val(), "title": $("#title").val(), "labels": labels}, function(data) {
					alert("Success!");
					dirty = false;
				});
			} else {
				alert("Nothing to save!");
			}
		}
		
		function newPost() {
			submit("post", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts?isDraft=" + !(confirm("Publish the post now?")) + "&fields=");
		}
		
		function update() {
			submit("put", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts/" + $("#posts").val() + "?fields=");
		}
		
		function publish() {
			if(confirm("Are you sure you want to publish this post?")) {
				ajax("post", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts/" + $("#posts").val() + "/publish?fields=", null, function(data) {
					alert("Success!");
				});
			}
		}
		
		function unpublish() {
			if(confirm("Are you sure you want to unpublish this post?")) {
				ajax("post", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts/" + $("#posts").val() + "/revert?fields=", null, function(data) {
					alert("Success!");
				});
			}
		}

		function delPost() {
			if(confirm("Are you sure you want to delete this post?")) {
				ajax("delete", "https://www.googleapis.com/blogger/v3/blogs/" + $("#blogs").val() + "/posts/" + $("#posts").val(), null, function(data) {
					alert("Success!");
				});
			}
		}

		function dirtify() {
			dirty = true;
			$("#preview").html($("#input").val());
		}
		
		$("#labels").change(dirtify);
		$("#input").change(dirtify);
		$("#title").change(dirtify);
		$("#input").keyup(dirtify);
	</script>
</body>
</html>
