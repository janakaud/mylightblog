<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
</head>
<body>
	<table style="height:100%;width:100%;position:absolute;top:0;bottom:0;left:0;right:0">
	<tbody>
	<tr>
		<td width="50%">
			<button onclick="authorize(void)">Authorize</button>
			<button onclick="listBlogs()">Blogs</button>
			<select id="blogs"></select>
		</td>
		<td>
			<button onclick="listPosts(true)">All</button>
			<button onclick="listPosts(false)">Draft</button>
			<select id="posts"></select>
		</td>
	</tr>
	<tr>
		<td>
			<input id="title" style="width:100%"/>
		</td>
		<td>
			<button onclick="loadPost()">Load</button>
			<button onclick="publish()">Publish</button>
			<button onclick="unpublish()">Unpublish</button>
			<button onclick="delPost()">Delete</button>
		</td>
	</tr>
	<tr style="height:100%">
		<td>
			<textarea id="input" style="width:100%;height:100%"></textarea>
		</td>
		<td>
			<iframe id="preview" style="overflow:scroll;width:100%;height:100%"></iframe>
		</td>
	</tr>
	<tr>
		<td>
			<input id="labels" style="width:100%"/>
		</td>
		<td>
			<button onclick="newPost()">New Post</button>
			<button onclick="update()">Update</button>
		</td>
	</tr>
	</tbody>
	</table>
	<script type="text/javascript">
		var acToken = localStorage.token;
		var expiry = localStorage.expiry;
		var dirty;
		var blogs = $("blogs");
		var posts = $("posts");
		var title = $("title");
		var input = $("input");
		var labels = $("labels");
		var preview = $("preview");

		function expired() {
			return !expiry || (new Date().getTime() - expiry >= 0);
		}
		
		function authorize(callback) {
			if(!expired())
				return callback();
			var win = window.open("https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/blogger&client_id=149292588439-vmendckat24eusmct1buat1ino6hp9c9.apps.googleusercontent.com&redirect_uri=http://127.0.0.1/blogger/oauth&response_type=token", "OAuthor", "width=500,height=200"); 
			win.addEventListener("load", function(e) {
				var win = e.target;
				if (win.location.hash.indexOf("access_token") != -1) {
					var hash = win.location.hash;
					hash = hash.substring(hash.indexOf("access_token=") + 13);
					acToken = hash.substring(0, hash.indexOf("&"));
					localStorage.token = acToken;
					hash = hash.substring(hash.indexOf("expires_in=") + 11);
					expiry = new Date().getTime() + parseInt(hash)*1000;
					localStorage.expiry = expiry;
					callback();
				} else
					alert("Authorization failed");
			}, true);
		}
		
		function callWithAuth(callback) {
			if(expired())
				authorize(callback);
			else
				callback();
		}
		
		function populate(list, data, textParam) {
			list.innerHTML = "";
			for(var i in data.items) {
				list.innerHTML += "<option value='" + data.items[i].id + "'>" + data.items[i][textParam] + "</option>";
			}
		}
		
		function $(id) {
			return document.getElementById(id);
		}
		
		function ajax(method, url, data, success) {
			callWithAuth(function() {
				alert(method + " " + url + " " + JSON.stringify(data));
				var xhr = new XMLHttpRequest();
				xhr.open(method, url, false);
				xhr.setRequestHeader("Authorization", "Bearer " + acToken);
				xhr.onload = function() {
					success(JSON.parse(this.responseText));
				};
				xhr.onerror = function(msg) {
					alert(JSON.stringify(msg, undefined, 2));
				};
				if(data) {
					xhr.setRequestHeader("Content-Type", "application/json");
					xhr.send(JSON.stringify(data));
				} else {
					xhr.send(null);
				}
			});
		}
		
		function listPosts(all) {
			ajax("get", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts?status=draft" + (all ? "&status=live" : "") + "&fields=items(id,title)", null, function(data) {
				populate(posts, data, "title");
			});
		}
		
		function listBlogs() {
			ajax("get", "https://www.googleapis.com/blogger/v3/users/self/blogs?fields=items(id,name)", null, function(data) {
				posts.innerHTML = "";
				populate(blogs, data, "name");
			});
		}
		
		function loadPost() {
			if(!dirty || confirm("Post has been modified. Are you sure you want to discard?")) {
				ajax("get", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts/" + posts.value + "?view=AUTHOR&fields=title,content,labels", null, function(data) {
					title.value = data.title;
					input.value = data.content;
					labels.value = (data.labels || []).join(", ");
					dirty = false;
				});
			}
		}
		
		function submit(method, url) {
			if(dirty) {
				var labelTxt = labels.value;
				var labelList = [];
				if(labelTxt.length > 0)
					labelList = labelTxt.split(/,\s*/g);
				for(var i in labelList) {
					if(labelList[i] == "") {
						alert("Invalid label");
						return;
					}
				}
				ajax(method, url, {"content": input.value, "title": title.value, "labels": labelList}, function(data) {
					alert("Success!");
					dirty = false;
				});
			} else {
				alert("Nothing to save!");
			}
		}
		
		function newPost() {
			submit("post", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts?isDraft=" + !(confirm("Publish the post now?")) + "&fields=");
		}
		
		function update() {
			submit("put", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts/" + posts.value + "?fields=");
		}
		
		function setPublished(publish) {
			var choice = publish ? ["publish", "publish"] : ["unpublish", "revert"];
			if(confirm("Are you sure you want to " + choice[0] + " this post?")) {
				ajax("post", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts/" + posts.value + "/" + choice[1] + "?fields=", null, function(data) {
					alert("Success!");
				});
			}
		}
		
		function publish() {
			setPublished(true);
		}
		
		function unpublish() {
			setPublished(false);
		}

		function delPost() {
			if(confirm("Are you sure you want to delete this post?")) {
				ajax("delete", "https://www.googleapis.com/blogger/v3/blogs/" + blogs.value + "/posts/" + posts.value, null, function(data) {
					alert("Success!");
				});
			}
		}

		function dirtify() {
			dirty = true;
			preview.src = "data:text/html;charset=utf-8," + input.value;
		}
		
		labels.onchange = dirtify;
		input.onchange = dirtify;
		title.onchange = dirtify;
		input.onkeyup = dirtify;
	</script>
</body>
</html>
